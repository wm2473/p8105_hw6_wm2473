---
title: "p8105_hw6_wm2473"
output: github_document
date: "2022-11-26"
---

```{r}
library(tidyverse)
library(readxl)
library(rvest)
library(ggplot2)
set.seed(1)
```

```{r}
hd = read_csv("homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = str_c(city,",", state), 
         homicides = case_when(disposition == "Closed without arrest" ~ "unsolved homicides", disposition == "Open/No arrest" ~ "unsolved homicides", disposition == "Closed by arrest" ~ "solved homicides"), homicides_1 = ifelse(
           disposition %in% c("Closed without arrest", "Open/No arrest"), 0, 1)) %>% 
    filter(!city_state %in% c("Tulsa,AL","Dallas,TX", "Phoenix,AZ", "Kansas City,MO"),victim_race %in% c("Black","White"), victim_age == as.numeric(victim_age))
```

obtain the estimate and confidence interval 
```{r}
md = hd %>% 
  filter(city_state %in% "Baltimore,MD") %>% 
  mutate(victim_age = as.numeric(victim_age), victim_race = as.factor(victim_race), victim_sex = as.factor(victim_sex), homicides_1 = ifelse(
           disposition %in% c("Closed without arrest", "Open/No arrest"), 0, 1))

fit_1 = glm(homicides_1 ~ victim_age+ victim_sex+ victim_race, data =md, family= binomial()) 
    
tidy = fit_1 %>% 
  broom::tidy() %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(OR = exp(estimate), lower = exp(estimate - 1.96 * std.error),
    upper = exp(estimate + 1.96 * std.error)) %>% 
select(term, OR, lower, upper)
```


```{r}
city_odds_ci = function(city_df){
  city_summarize = city_df %>%
  summarise(
    unsolved = sum(homicides == "solved homicides"),
    n = n())
  
  fit_test = glm(homicides_1 ~ victim_age + victim_sex + victim_race, data =hd, family= binomial()) 
  broom::tidy() %>% 

  return(fit_test)
  
}
```

```{r}
nested_df = hd %>%
  nest(alldata = uid:homicides_1) %>% 
  mutate(
    test_results = map(alldata, city_odds_ci),
    cleanresults = map(test_results, broom::tidy)
  ) %>% 
  select(city_state, cleanresults) %>% 
  unnest(cleanresults) %>% 
  select(city_state, estimate, starts_with("conf"))
```

